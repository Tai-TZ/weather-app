<div class="admin-cities-container">
    <!-- Header Section -->
    <div class="page-header">
        <div class="header-content">
            <div class="title-section">
                <h1 class="page-title">
                    <mat-icon class="title-icon">location_city</mat-icon>
                    Quản lý thành phố
                </h1>
                <p class="page-subtitle">
                    Quản lý danh sách các thành phố và thông tin địa lý
                </p>
            </div>

            <div class="header-actions">
                <button mat-raised-button color="primary" (click)="openAddDialog()" class="add-btn">
                    <mat-icon>add</mat-icon>
                    Thêm thành phố
                </button>

                <button mat-raised-button color="accent" (click)="exportData()" class="export-btn">
                    <mat-icon>download</mat-icon>
                    Xuất dữ liệu
                </button>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <mat-card class="search-card">
        <mat-card-content>
            <form [formGroup]="searchForm" class="search-form">
                <div class="search-controls">
                    <mat-form-field appearance="outline" class="search-field" subscriptSizing="dynamic">
                        <mat-label>Tìm kiếm thành phố</mat-label>
                        <input matInput formControlName="searchTerm"
                            placeholder="Nhập tên thành phố, quốc gia hoặc vùng">
                        <mat-icon matPrefix>search</mat-icon>
                        <button mat-icon-button matSuffix *ngIf="searchForm.get('searchTerm')?.value"
                            (click)="searchForm.get('searchTerm')?.setValue('')">
                            <mat-icon>clear</mat-icon>
                        </button>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="filter-field" subscriptSizing="dynamic">
                        <mat-label>Trạng thái</mat-label>
                        <mat-select formControlName="filterActive">
                            <mat-option [value]="null">Tất cả</mat-option>
                            <mat-option [value]="true">Hoạt động</mat-option>
                            <mat-option [value]="false">Không hoạt động</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </form>
        </mat-card-content>
    </mat-card>

    <!-- Bulk Actions -->
    <div class="bulk-actions" *ngIf="selection.selected.length > 0">
        <mat-card>
            <mat-card-content>
                <div class="bulk-actions-content">
                    <span class="selection-count">
                        Đã chọn {{ selection.selected.length }} thành phố
                    </span>

                    <div class="bulk-buttons">
                        <button mat-raised-button color="primary" (click)="bulkToggleStatus()">
                            <mat-icon>toggle_on</mat-icon>
                            Đổi trạng thái
                        </button>

                        <button mat-raised-button color="warn" (click)="bulkDelete()">
                            <mat-icon>delete</mat-icon>
                            Xóa đã chọn
                        </button>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>
    </div>

    <!-- Data Table -->
    <mat-card class="table-card">
        <mat-card-content>
            <div class="table-container">
                <table mat-table [dataSource]="dataSource" matSort class="cities-table">

                    <!-- Checkbox Column -->
                    <ng-container matColumnDef="select">
                        <th mat-header-cell *matHeaderCellDef>
                            <mat-checkbox (change)="$event ? toggleSelectAll() : null"
                                [checked]="selection.hasValue() && isAllSelected()"
                                [indeterminate]="selection.hasValue() && !isAllSelected()" [aria-label]="'select all'">
                            </mat-checkbox>
                        </th>
                        <td mat-cell *matCellDef="let row">
                            <mat-checkbox (click)="$event.stopPropagation()"
                                (change)="$event ? selection.toggle(row) : null" [checked]="selection.isSelected(row)"
                                [aria-label]="'select'">
                            </mat-checkbox>
                        </td>
                    </ng-container>

                    <!-- Name Column -->
                    <ng-container matColumnDef="name">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Tên thành phố</th>
                        <td mat-cell *matCellDef="let city">
                            <div class="city-name">
                                <strong>{{ city.name }}</strong>
                                <span class="weather-station" *ngIf="city.weatherStationId">
                                    ID: {{ city.weatherStationId }}
                                </span>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Country Column -->
                    <ng-container matColumnDef="country">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Quốc gia</th>
                        <td mat-cell *matCellDef="let city">{{ city.country }}</td>
                    </ng-container>

                    <!-- Region Column -->
                    <ng-container matColumnDef="region">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Vùng/Khu vực</th>
                        <td mat-cell *matCellDef="let city">{{ city.region }}</td>
                    </ng-container>

                    <!-- Population Column -->
                    <ng-container matColumnDef="population">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Dân số</th>
                        <td mat-cell *matCellDef="let city">
                            {{ formatPopulation(city.population) }}
                        </td>
                    </ng-container>

                    <!-- Coordinates Column -->
                    <ng-container matColumnDef="coordinates">
                        <th mat-header-cell *matHeaderCellDef>Tọa độ</th>
                        <td mat-cell *matCellDef="let city">
                            <div class="coordinates">
                                {{ formatCoordinates(city.coordinates.lat, city.coordinates.lon) }}
                            </div>
                        </td>
                    </ng-container>

                    <!-- Timezone Column -->
                    <ng-container matColumnDef="timezone">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Múi giờ</th>
                        <td mat-cell *matCellDef="let city">
                            <code class="timezone">{{ city.timezone }}</code>
                        </td>
                    </ng-container>

                    <!-- Status Column -->
                    <ng-container matColumnDef="isActive">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Trạng thái</th>
                        <td mat-cell *matCellDef="let city">
                            <mat-chip [class.active-chip]="city.isActive" [class.inactive-chip]="!city.isActive">
                                {{ city.isActive ? 'Hoạt động' : 'Không hoạt động' }}
                            </mat-chip>
                        </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef>Thao tác</th>
                        <td mat-cell *matCellDef="let city">
                            <div class="actions-cell">
                                <button mat-icon-button (click)="openEditDialog(city)" matTooltip="Chỉnh sửa"
                                    color="primary">
                                    <mat-icon>edit</mat-icon>
                                </button>

                                <button mat-icon-button (click)="deleteCity(city)" matTooltip="Xóa" color="warn">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </div>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>

                <!-- No Data State -->
                <div class="no-data" *ngIf="dataSource.filteredData.length === 0">
                    <mat-icon class="no-data-icon">location_off</mat-icon>
                    <h3>Không tìm thấy thành phố nào</h3>
                    <p *ngIf="searchTerm()">
                        Không có thành phố nào phù hợp với "{{ searchTerm() }}"
                    </p>
                    <p *ngIf="!searchTerm()">
                        Chưa có dữ liệu thành phố. Hãy thêm thành phố đầu tiên!
                    </p>
                </div>
            </div>

            <!-- Paginator -->
            <mat-paginator [pageSizeOptions]="[5, 10, 20, 50]" [pageSize]="10" showFirstLastButtons
                aria-label="Select page">
            </mat-paginator>
        </mat-card-content>
    </mat-card>

    <!-- Add/Edit Form Dialog -->
    <div class="form-dialog" *ngIf="selectedCity() !== null || cityForm.touched">
        <mat-card class="form-card">
            <mat-card-header>
                <mat-card-title>
                    {{ selectedCity() ? 'Chỉnh sửa thành phố' : 'Thêm thành phố mới' }}
                </mat-card-title>
            </mat-card-header>

            <mat-card-content>
                <form [formGroup]="cityForm" (ngSubmit)="saveCity()">
                    <div class="form-grid">
                        <!-- Basic Information -->
                        <div class="form-section">
                            <h3 class="section-title">Thông tin cơ bản</h3>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Tên thành phố</mat-label>
                                    <input matInput formControlName="name" placeholder="Nhập tên thành phố">
                                    <mat-error>{{ getFormError('name') }}</mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Quốc gia</mat-label>
                                    <input matInput formControlName="country" placeholder="Nhập tên quốc gia">
                                    <mat-error>{{ getFormError('country') }}</mat-error>
                                </mat-form-field>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Vùng/Khu vực</mat-label>
                                    <input matInput formControlName="region" placeholder="Nhập vùng hoặc khu vực">
                                    <mat-error>{{ getFormError('region') }}</mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Dân số</mat-label>
                                    <input matInput type="number" formControlName="population"
                                        placeholder="Nhập số dân">
                                    <mat-error>{{ getFormError('population') }}</mat-error>
                                </mat-form-field>
                            </div>
                        </div>

                        <!-- Geographic Information -->
                        <div class="form-section">
                            <h3 class="section-title">Thông tin địa lý</h3>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Vĩ độ (Latitude)</mat-label>
                                    <input matInput type="number" step="0.0001" formControlName="lat"
                                        placeholder="-90 đến 90">
                                    <mat-error>{{ getFormError('lat') }}</mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Kinh độ (Longitude)</mat-label>
                                    <input matInput type="number" step="0.0001" formControlName="lon"
                                        placeholder="-180 đến 180">
                                    <mat-error>{{ getFormError('lon') }}</mat-error>
                                </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="form-field full-width">
                                <mat-label>Múi giờ</mat-label>
                                <input matInput formControlName="timezone" placeholder="Ví dụ: Asia/Ho_Chi_Minh">
                                <mat-error>{{ getFormError('timezone') }}</mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="form-field full-width">
                                <mat-label>ID Trạm thời tiết (Tùy chọn)</mat-label>
                                <input matInput formControlName="weatherStationId" placeholder="Nhập ID trạm thời tiết">
                                <mat-error>{{ getFormError('weatherStationId') }}</mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Status -->
                        <div class="form-section full-width">
                            <h3 class="section-title">Trạng thái</h3>

                            <mat-slide-toggle formControlName="isActive" class="status-toggle">
                                <div class="toggle-content">
                                    <span class="toggle-title">Kích hoạt thành phố</span>
                                    <span class="toggle-desc">Thành phố này sẽ hiển thị trong danh sách tìm kiếm</span>
                                </div>
                            </mat-slide-toggle>
                        </div>
                    </div>
                </form>
            </mat-card-content>

            <mat-card-actions align="end">
                <button mat-button type="button" (click)="cancelEdit()">
                    Hủy
                </button>
                <button mat-raised-button color="primary" (click)="saveCity()"
                    [disabled]="cityForm.invalid || isLoading()">
                    <mat-icon *ngIf="isLoading()">refresh</mat-icon>
                    <mat-icon *ngIf="!isLoading()">save</mat-icon>
                    {{ isLoading() ? 'Đang lưu...' : 'Lưu' }}
                </button>
            </mat-card-actions>
        </mat-card>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="isLoading()">
        <mat-spinner diameter="50"></mat-spinner>
    </div>
</div>